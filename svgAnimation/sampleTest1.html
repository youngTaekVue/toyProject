<!DOCTYPE html>
<html>
<head>
    <title>Google Map Lotto Store Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

    <style>
        /* 지도를 담을 div의 크기는 반드시 지정해야 합니다. */
        #map {
            height: 100vh; /* 전체 뷰포트 높이 */
            width: 100%; /* 전체 뷰포트 너비 */
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    // -----------------------------------------------------------
    // 1. 전역 변수 선언 및 가상 데이터 (약 20개)
    // -----------------------------------------------------------

    let map; // 지도 객체를 저장할 전역 변수
    let currentMarkers = []; // 현재 지도에 표시된 마커들을 관리할 배열
    let infoWindow; // InfoWindow 객체를 저장할 전역 변수

    // 지도 중심 좌표 (서울)
    const SEOUL_CENTER = { lat: 37.5665, lng: 126.9780 };

    // 로또 판매점 가상 데이터 (약 20개)
    const LOTTO_STORES = [
        { lat: 37.5668, lng: 126.9784, name: "서울시청점", firstWins: 5, secondWins: 12 },
        { lat: 37.5600, lng: 126.9850, name: "명동점", firstWins: 10, secondWins: 25 },
        { lat: 37.5750, lng: 126.9720, name: "경복궁역점", firstWins: 2, secondWins: 5 },
        { lat: 37.5550, lng: 126.9650, name: "남대문점", firstWins: 8, secondWins: 18 },
        { lat: 37.5800, lng: 126.9800, name: "종로3가점", firstWins: 15, secondWins: 30 },
        { lat: 37.5450, lng: 127.0000, name: "을지로4가점", firstWins: 3, secondWins: 7 },
        { lat: 37.5300, lng: 126.9950, name: "한남동점", firstWins: 6, secondWins: 14 },
        { lat: 37.5250, lng: 127.0200, name: "압구정점", firstWins: 12, secondWins: 28 },
        { lat: 37.5100, lng: 127.0500, name: "삼성역점", firstWins: 9, secondWins: 20 },
        { lat: 37.5050, lng: 127.0650, name: "선릉점", firstWins: 4, secondWins: 9 },
        { lat: 37.4950, lng: 127.0300, name: "강남역점", firstWins: 18, secondWins: 40 },
        { lat: 37.5850, lng: 127.0050, name: "동대문점", firstWins: 7, secondWins: 16 },
        { lat: 37.5500, lng: 127.0750, name: "건대입구점", firstWins: 1, secondWins: 3 },
        { lat: 37.5900, lng: 126.9500, name: "신촌점", firstWins: 11, secondWins: 23 },
        { lat: 37.6000, lng: 127.0250, name: "대학로점", firstWins: 2, secondWins: 4 },
        { lat: 37.5400, lng: 126.9350, name: "여의도점", firstWins: 14, secondWins: 35 },
        { lat: 37.4800, lng: 126.9500, name: "보라매공원점", firstWins: 3, secondWins: 6 },
        { lat: 37.4700, lng: 127.0400, name: "양재점", firstWins: 8, secondWins: 17 },
        { lat: 37.5700, lng: 126.8900, name: "마포구청점", firstWins: 6, secondWins: 13 },
        { lat: 37.5350, lng: 126.8650, name: "목동점", firstWins: 13, secondWins: 32 }
    ];

    // -----------------------------------------------------------
    // 2. 지도 초기화 함수 (Google Maps API 콜백)
    // -----------------------------------------------------------

    function initMap() {
        // 맵 객체 생성 및 HTML 요소에 연결
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,        // 초기 확대 레벨
            center: SEOUL_CENTER, // 지도 중심 좌표
            mapId: 'DEMO_MAP_ID'
        });

        // 정보 창(InfoWindow) 객체 생성
        infoWindow = new google.maps.InfoWindow();

        // **핵심: 지도 조작이 멈출 때마다 마커를 업데이트합니다.**
        map.addListener('idle', loadAndDisplayMarkers);

        // 초기 로딩 시 마커 표시 (idle 이벤트가 자동으로 호출되지만 명시적으로 호출 가능)
        // loadAndDisplayMarkers();
    }

    // -----------------------------------------------------------
    // 3. 마커 로딩 및 표시 로직
    // -----------------------------------------------------------

    /**
     * 현재 뷰포트(화면 경계) 내의 데이터만 필터링하여 마커를 표시합니다.
     */
    function loadAndDisplayMarkers() {
        if (!map) return; // 지도가 아직 초기화되지 않았으면 종료

        // 1. 기존 마커를 지도에서 숨기고 배열을 초기화합니다.
        clearMarkers();

        // 2. 현재 화면 경계(Bounds)를 가져옵니다.
        const bounds = map.getBounds();
        if (!bounds) return; // 경계가 정의되지 않았으면 종료

        // 3. 로컬 데이터에서 경계 내의 판매점만 필터링합니다.
        const visibleStores = LOTTO_STORES.filter(store => {
            const position = new google.maps.LatLng(store.lat, store.lng);
            return bounds.contains(position);
        });

        // 4. 필터링된 데이터로 새 마커를 생성하여 지도에 표시합니다.
        visibleStores.forEach(store => {
            const marker = createMarker(map, store);
            currentMarkers.push(marker); // 마커를 관리 배열에 추가
        });

        console.log(`지도에 ${currentMarkers.length}개의 마커가 표시되었습니다.`);
    }

    /**
     * 마커 객체를 생성하고 클릭 리스너를 추가하는 헬퍼 함수.
     * @param {google.maps.Map} map - 지도 객체
     * @param {Object} store - 로또 판매점 데이터 객체
     * @returns {google.maps.Marker} 생성된 마커 객체
     */
    function createMarker(map, store) {
        const position = { lat: store.lat, lng: store.lng };

        const marker = new google.maps.Marker({
            position: position,
            map: map,
            title: store.name
        });

        // 마커 클릭 이벤트 리스너 추가
        marker.addListener('click', () => {
            const content = `
                <div style="padding: 10px;">
                    <h3>${store.name}</h3>
                    <p><strong>로또 1등 당첨:</strong> ${store.firstWins}회 🏆</p>
                    <p><strong>로또 2등 당첨:</strong> ${store.secondWins}회</p>
                </div>
            `;
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
        });

        return marker;
    }

    /**
     * 현재 지도에 표시된 모든 마커를 제거합니다.
     */
    function clearMarkers() {
        currentMarkers.forEach(marker => {
            marker.setMap(null); // 지도에서 마커를 제거
        });
        currentMarkers = []; // 배열 초기화
    }
</script>

<script async
        src="https://maps.googleapis.com/maps/api/js?key=&callback=initMap">
</script>
</body>
</html>